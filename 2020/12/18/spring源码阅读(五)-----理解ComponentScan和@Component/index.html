<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>spring源码阅读(五)-----理解ComponentScan和@Component | 不喝酒的烟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spring源码阅读(五)-----理解ComponentScan和@Component</h1><a id="logo" href="/.">不喝酒的烟</a><p class="description">随便写写</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spring源码阅读(五)-----理解ComponentScan和@Component</h1><div class="post-meta">2020-12-18<span> | </span><span class="category"><a href="/categories/spring%E6%BA%90%E7%A0%81/">spring源码</a></span></div><a class="disqus-comment-count" href="/2020/12/18/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%94)-----%E7%90%86%E8%A7%A3ComponentScan%E5%92%8C@Component/#vcomment"><span class="valine-comment-count" data-xid="/2020/12/18/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%94)-----%E7%90%86%E8%A7%A3ComponentScan%E5%92%8C@Component/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">2.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#component-scan%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">component-scan的解析</span></a></li></ol></div></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本章节，我们通过自定义标component-scan的解析，看看@Component是如何实现的。</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><ol>
<li>spring2.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">		http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.springframework.mytest&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>CompoBean1<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompoBean1</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;I am send method from CompoBean1!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>CompoBean2<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompoBean2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> CompoBean1 compoBean1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		compoBean1.send();</span><br><span class="line">		System.out.println(<span class="string">&quot;I am send method from CompoBean2!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试XmlBeanFactoryTest<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyXmlBeanFactoryTest</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">xmlBeanFactoryTest8</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> XmlBeanFactory( <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;spring2.xml&quot;</span>));</span><br><span class="line">		CompoBean1 bean = (CompoBean1) bf.getBean(<span class="string">&quot;compoBean1&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">xmlBeanFactoryTest9</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> XmlBeanFactory( <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;spring2.xml&quot;</span>));</span><br><span class="line">		CompoBean2 bean = (CompoBean2) bf.getBean(<span class="string">&quot;compoBean2&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">xmlBeanFactoryTest10</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> XmlBeanFactory( <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;spring2.xml&quot;</span>));</span><br><span class="line">		BeanPostProcessor autowiredAnnotationBeanPostProcessor = (BeanPostProcessor) bf.getBean(<span class="string">&quot;org.springframework.context.annotation&quot;</span> +</span><br><span class="line">				<span class="string">&quot;.internalAutowiredAnnotationProcessor&quot;</span>);</span><br><span class="line">		((XmlBeanFactory) bf).addBeanPostProcessor(autowiredAnnotationBeanPostProcessor);</span><br><span class="line">		CompoBean2 bean = (CompoBean2) bf.getBean(<span class="string">&quot;compoBean2&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试ClassPathXmlApplicationTest<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathXmlApplicationTest</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">classPathXml4</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring2.xml&quot;</span>);</span><br><span class="line">		CompoBean1 bean = (CompoBean1) bf.getBean(<span class="string">&quot;compoBean1&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">classPathXml5</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring2.xml&quot;</span>);</span><br><span class="line">		CompoBean2 bean = (CompoBean2) bf.getBean(<span class="string">&quot;compoBean2&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="component-scan的解析"><a href="#component-scan的解析" class="headerlink" title="component-scan的解析"></a>component-scan的解析</h2><p>同样的步骤，找到component-scan标签的解析类ComponentScanBeanDefinitionParser。可以看到，ComponentScanBeanDefinitionParser定义了很多static final String。这些都是component-scan可配置的属性，除了base-package，其他我们全都使用默认值即可。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ComponentScanBeanDefinitionParser.class</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">public</span> BeanDefinition <span class="function"><span class="title">parse</span>(<span class="params">Element element, ParserContext parserContext</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">String</span> basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE);</span><br><span class="line">		basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);</span><br><span class="line">		<span class="built_in">String</span>[] basePackages = StringUtils.tokenizeToStringArray(basePackage,</span><br><span class="line">				ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Actually scan for bean definitions and register them.</span></span><br><span class="line">		ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element);</span><br><span class="line">		<span class="built_in">Set</span>&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages);</span><br><span class="line">		registerComponents(parserContext.getReaderContext(), beanDefinitions, element);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>configureScanner(parserContext, element)就是解析component-scan的各种配置，尤其是includeFilters和excludeFilters。通过这两个配置，你可以用自己定义的标签替换掉spring默认标签。系统由4中类型的TypeFilter：AnnotationTypeFilter，AssignableTypeFilter，AspectJTypeFilter，RegexPatternTypeFilter。这4中TypeFilter的功能从名称应该就能看出来。另外，也可以注入我们自定义的TypeFilter。通常，我们use-default-filters。默认过滤器在includeFilters添加@Component注解，另外两个注解@ManagedBean和@Named，一般不会使用。这样看来， component-scan默认好像只会扫描@Component注解。<br>我们先来看看扫描的关键代码。configureScanner(parserContext, element)比较简单，就是创建一个扫描器，配置各种默认属性。对@Component注解的支持就是在这里注入的。Set<BeanDefinitionHolder> beanDefinitions = scanner.doScan(basePackages)是比较核心的代码，它的功能主要是扫描特定路径下的class文件，并将扫描器允许的class文件解析为BeanDefinition。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">ClassPathBeanDefinitionScanner</span>.</span></span><span class="keyword">class</span></span><br><span class="line"></span><br><span class="line">protected Set&lt;BeanDefinitionHolder&gt; <span class="keyword">do</span><span class="constructor">Scan(String<span class="operator">...</span> <span class="params">basePackages</span>)</span> &#123;</span><br><span class="line">		<span class="module-access"><span class="module"><span class="identifier">Assert</span>.</span></span>not<span class="constructor">Empty(<span class="params">basePackages</span>, <span class="string">&quot;At least one base package must be specified&quot;</span>)</span>;</span><br><span class="line">		Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">new</span> LinkedHashSet&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">		<span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">			Set&lt;BeanDefinition&gt; candidates = find<span class="constructor">CandidateComponents(<span class="params">basePackage</span>)</span>;</span><br><span class="line">		    ……</span><br><span class="line">		&#125;</span><br><span class="line">		return beanDefinitions;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我们只需要看findCandidateComponents(basePackage)做了哪些工作，其他的都是细枝末节，跟着代码执行很容易看懂。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">Set</span>&lt;BeanDefinition&gt; <span class="function"><span class="title">findCandidateComponents</span>(<span class="params"><span class="built_in">String</span> basePackage</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.componentsIndex != <span class="literal">null</span> &amp;&amp; indexSupportsIncludeFilters()) &#123;</span><br><span class="line">			<span class="keyword">return</span> addCandidateComponentsFromIndex(<span class="built_in">this</span>.componentsIndex, basePackage);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> scanCandidateComponents(basePackage);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>第一个条件涉及到新增的接口@Index,据说是用来提升应用启动速度的，我们先不管。我们主要关注scanCandidateComponents(basePackage)的实现。扫描base-package路径下所有的文件，由MetadataReader转化class元数据，再将MetadataReader转化为ScannedGenericBeanDefinition。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;BeanDefinition&gt; scan<span class="constructor">CandidateComponents(String <span class="params">basePackage</span>)</span> &#123;</span><br><span class="line">		……</span><br><span class="line">						MetadataReader metadataReader = get<span class="constructor">MetadataReaderFactory()</span>.get<span class="constructor">MetadataReader(<span class="params">resource</span>)</span>;</span><br><span class="line">						……</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的重点比较难找，不往里面深入，几乎很难找到转化class元数据的代码在哪里。我们把前后不重要的都删掉，将最核心的代码块标记出来。<br>getMetadataReaderFactory()其实也没什么，因为MetadataReaderFactory的实现类只有SimpleMetadataReaderFactory和CachingMetadataReaderFactory两个，还是父子关系。并且getMetadataReader(resource)的核心逻辑最终还是会走向SimpleMetadataReaderFactory。<br>接下来，getMetadataReader(resource)将要展示的就是spring里面最重要的技术之一，ASM字节码技术。我们熟知的spring两大代理之一CGLIB,底层技术就是ASM。spring的ASM包org.springframework.asm，其实大部分代码和org.objectweb.asm一样，只不过在org.objectweb.asm的基础上增加了一些简单的修改和限制。当然，你要问修改了那些地方，我也不是很清楚，最起码static final int EXPAND_ASM_INSNS = 256，这个限制原ASM就没有。其他地方肯定也有小的改动，只不过字节码这一块比较复杂，以后可能会单开一个系列，讲一讲ASM，Javaassist，Java Instrument等字节码技术的使用。<br>通过对字节码的解析，将class文件解析成了MetadataReader，MetadataReader唯一的实现类SimpleMetadataReader。SimpleMetadataReader里面除了Resource之外，只有两个属性ClassMetadata和AnnotationMetadata，AnnotationMetadata同时也是ClassMetadata的子接口，在此处都是实现类AnnotationMetadataReadingVisitor。所以在这里的MetadataReader里面，ClassMetadata和AnnotationMetadata是同一个对象，存储的都是class的元数据描述。<br>接下来就是将这些元数据转化为ScannedGenericBeanDefinition。这样，所有的@Component注解类，都转化为ScannedGenericBeanDefinition，并注入到了容器中。<br>component-scan除了识别的@Component注解外，还实现了annotation-config的功能，所以同样也实现了@Autowired的功能。<br>@Service @Controller @Repository都派生自@Component，所以同样可以通过筛选。<br>如果你对派生注解如何关联感兴趣的话，往下追踪，会走到AnnotationAttributesReadingVisitor的visitEnd()，这里就是处理派生注解的逻辑。不感兴趣的，可以跳过字节码这一部分。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">AnnotationAttributesReadingVisitor.class</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">visitEnd</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>.visitEnd();</span><br><span class="line"></span><br><span class="line">		Class&lt;? <span class="keyword">extends</span> Annotation&gt; annotationClass = <span class="built_in">this</span>.attributes.annotationType();</span><br><span class="line">		<span class="keyword">if</span> (annotationClass != <span class="literal">null</span>) &#123;</span><br><span class="line">			List&lt;AnnotationAttributes&gt; attributeList = <span class="built_in">this</span>.attributesMap.get(<span class="built_in">this</span>.annotationType);</span><br><span class="line">			<span class="keyword">if</span> (attributeList == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="built_in">this</span>.attributesMap.add(<span class="built_in">this</span>.annotationType, <span class="built_in">this</span>.attributes);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				attributeList.add(<span class="number">0</span>, <span class="built_in">this</span>.attributes);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!AnnotationUtils.isInJavaLangAnnotationPackage(annotationClass.getName())) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Annotation[] metaAnnotations = annotationClass.getAnnotations();</span><br><span class="line">					<span class="keyword">if</span> (!ObjectUtils.isEmpty(metaAnnotations)) &#123;</span><br><span class="line">						<span class="built_in">Set</span>&lt;Annotation&gt; visited = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">						<span class="keyword">for</span> (Annotation metaAnnotation : metaAnnotations) &#123;</span><br><span class="line">							recursivelyCollectMetaAnnotations(visited, metaAnnotation);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (!visited.isEmpty()) &#123;</span><br><span class="line">							<span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; metaAnnotationTypeNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(visited.size());</span><br><span class="line">							<span class="keyword">for</span> (Annotation ann : visited) &#123;</span><br><span class="line">								metaAnnotationTypeNames.add(ann.annotationType().getName());</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="built_in">this</span>.metaAnnotationMap.put(annotationClass.getName(), metaAnnotationTypeNames);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">&quot;Failed to introspect meta-annotations on &quot;</span> + annotationClass + <span class="string">&quot;: &quot;</span> + ex);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

</div><div class="tags"><a href="/tags/spring/"><i class="fa fa-tag"></i>spring</a><a href="/tags/%E6%BA%90%E7%A0%81/"><i class="fa fa-tag"></i>源码</a><a href="/tags/%E6%9E%B6%E6%9E%84/"><i class="fa fa-tag"></i>架构</a></div><div class="post-nav"><a class="next" href="/2020/12/16/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%9B%9B)-----%E7%90%86%E8%A7%A3@Autowired/">spring源码阅读(四)-----理解@Autowired</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'m1L4QofvaTBynd4G4ARXUBIv-gzGzoHsz',
  appKey:'q7tSFtGgIvgO1ScyMtQdvUkR',
  placeholder:'Just so so',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/spring%E6%BA%90%E7%A0%81/">spring源码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 15px;">源码</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 15px;">架构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/18/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%94)-----%E7%90%86%E8%A7%A3ComponentScan%E5%92%8C@Component/">spring源码阅读(五)-----理解ComponentScan和@Component</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/16/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%9B%9B)-----%E7%90%86%E8%A7%A3@Autowired/">spring源码阅读(四)-----理解@Autowired</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/14/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%89)-----Bean%E7%9A%84%E5%8A%A0%E8%BD%BD/">spring源码阅读(三)-----Bean的加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/01/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%8C)-----BeanDefinition%E7%9A%84%E6%B3%A8%E5%86%8C/">spring源码阅读(二)-----资源加载与BeanDefinition注册</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/01/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)-----%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/">spring源码阅读(一)-----核心流程</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">不喝酒的烟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":350,"height":650},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>