<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>spring源码阅读(七)-----理解@Configuration | 不喝酒的烟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">spring源码阅读(七)-----理解@Configuration</h1><a id="logo" href="/.">不喝酒的烟</a><p class="description">随便写写</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">spring源码阅读(七)-----理解@Configuration</h1><div class="post-meta">2020-12-30<span> | </span><span class="category"><a href="/categories/spring%E6%BA%90%E7%A0%81/">spring源码</a></span></div><a class="disqus-comment-count" href="/2020/12/30/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)-----%E7%90%86%E8%A7%A3@Configuration/#vcomment"><span class="valine-comment-count" data-xid="/2020/12/30/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)-----%E7%90%86%E8%A7%A3@Configuration/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">2.</span> <span class="toc-text">单元测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigurationClassPostProcessor"><span class="toc-number">3.</span> <span class="toc-text">ConfigurationClassPostProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#postProcessBeanDefinitionRegistry-BeanDefinitionRegistry-registry"><span class="toc-number">3.1.</span> <span class="toc-text">postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E5%87%BA%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84BeanDefinition%EF%BC%8C%E6%89%93%E4%B8%8A%E6%A0%87%E8%AE%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text">筛选出符合条件的BeanDefinition，打上标记</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E4%B8%AAConfigurationClassParser%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A7%A3%E6%9E%90%E5%A4%87%E9%80%89%E7%9A%84BeanDefinition"><span class="toc-number">3.1.2.</span> <span class="toc-text">实例化一个ConfigurationClassParser，用来解析备选的BeanDefinition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.1.3.</span> <span class="toc-text">解析注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDBeanDefinition"><span class="toc-number">3.1.4.</span> <span class="toc-text">加载BeanDefinition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#postProcessBeanFactory-ConfigurableListableBeanFactory-beanFactory"><span class="toc-number">3.2.</span> <span class="toc-text">postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E9%85%8D%E7%BD%AE%E7%B1%BB%E8%BF%9B%E8%A1%8C%E5%A2%9E%E5%BC%BA"><span class="toc-number">3.2.1.</span> <span class="toc-text">对配置类进行增强</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本章节，我们看看ConfigurationClassPostProcessor是如何处理@Configuration的。</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><ol>
<li>spring2.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">	   <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">		http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.springframework.mytest&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>ConfigBean1<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean1</span> &#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.<span class="built_in">println</span>(<span class="string">&quot;I am send method from ConfigBean1!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>ConfigBean2<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean2</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ConfigBean1 configBean1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">setConfigBean1</span>(<span class="params">ConfigBean1 configBean1</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.configBean1 = configBean1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		configBean1.send();</span><br><span class="line">		System.out.println(<span class="string">&quot;I am send method from ConfigBean2!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>org.springframework.scantest.ConfigBean3<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean3</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;I am send method from ConfigBean3!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>org.springframework.scantest.ConfigBean4<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ConfigBean3 compoBean3;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		compoBean3.send();</span><br><span class="line">		System.out.println(<span class="string">&quot;I am send method from ConfigBean4!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>JavaConfig<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">&quot;org.springframework.scantest&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> ConfigBean1 <span class="function"><span class="title">configBean1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ConfigBean1();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> ConfigBean2 <span class="function"><span class="title">configBean2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		ConfigBean2 configBean2 =  <span class="keyword">new</span> ConfigBean2();</span><br><span class="line">		configBean2.setConfigBean1(configBean1());</span><br><span class="line">		<span class="keyword">return</span> configBean2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试ClassPathXmlApplicationTest<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathXmlApplicationTest</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">classPathXml8</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring2.xml&quot;</span>);</span><br><span class="line">		ConfigBean2 bean = (ConfigBean2) bf.getBean(<span class="string">&quot;configBean2&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">classPathXml9</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		BeanFactory bf = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring2.xml&quot;</span>);</span><br><span class="line">		ConfigBean4 bean = (ConfigBean4) bf.getBean(<span class="string">&quot;configBean4&quot;</span>);</span><br><span class="line">		bean.send();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a>ConfigurationClassPostProcessor</h2><p>ConfigurationClassPostProcessor是一个BeanFactoryPostProcessor，也是一个BeanDefinitionRegistryPostProcessor。<br><img src="https://cdn.jsdelivr.net/gh/engimatic/privateimage@main/img/ConfigurationClassPostProcessor.png"><br>在ClassPathXmlApplicationContext的流程中讲过，是在invokeBeanFactoryPostProcessors(beanFactory)方法中将所有的BeanFactoryPostProcessor实例化，并且执行其方法。先执行BeanDefinitionRegistryPostProcessor，在执行BeanFactoryPostProcessor。所以在ConfigurationClassPostProcessor中先执行BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry方法，再执行BeanFactoryPostProcessor的postProcessBeanFactory方法。</p>
<h3 id="postProcessBeanDefinitionRegistry-BeanDefinitionRegistry-registry"><a href="#postProcessBeanDefinitionRegistry-BeanDefinitionRegistry-registry" class="headerlink" title="postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)"></a>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationClassPostProcessor.class</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">postProcessBeanDefinitionRegistry</span>(<span class="params">BeanDefinitionRegistry registry</span>)</span> &#123;</span><br><span class="line">		int registryId = System.identityHashCode(registry);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">					<span class="string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">					<span class="string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">this</span>.registriesPostProcessed.add(registryId);</span><br><span class="line"></span><br><span class="line">		processConfigBeanDefinitions(registry);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>主要流程在processConfigBeanDefinitions(registry)中。这个方法比较重要，没有多少可以跳过的。下面分为几步，一步一步详细讲解。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">processConfigBeanDefinitions</span>(<span class="params">BeanDefinitionRegistry registry</span>)</span> &#123;</span><br><span class="line">		List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="built_in">String</span>[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">String</span> beanName : candidateNames) &#123;</span><br><span class="line">			BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line">			<span class="keyword">if</span> (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||</span><br><span class="line">					ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">				configCandidates.add(<span class="keyword">new</span> BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		……</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Parse each @Configuration class</span></span><br><span class="line">		ConfigurationClassParser parser = <span class="keyword">new</span> ConfigurationClassParser(</span><br><span class="line">				<span class="built_in">this</span>.metadataReaderFactory, <span class="built_in">this</span>.problemReporter, <span class="built_in">this</span>.environment,</span><br><span class="line">				<span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">Set</span>&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line">		<span class="built_in">Set</span>&lt;ConfigurationClass&gt; alreadyParsed = <span class="keyword">new</span> HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			parser.parse(candidates);</span><br><span class="line">			parser.validate();</span><br><span class="line"></span><br><span class="line">			<span class="built_in">Set</span>&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">			configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.reader == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="built_in">this</span>.reader = <span class="keyword">new</span> ConfigurationClassBeanDefinitionReader(</span><br><span class="line">						registry, <span class="built_in">this</span>.sourceExtractor, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.environment,</span><br><span class="line">						<span class="built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">			alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">			candidates.clear();</span><br><span class="line">			<span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">				<span class="built_in">String</span>[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">				<span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; oldCandidateNames = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">				<span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; alreadyParsedClasses = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">				<span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">					alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">for</span> (<span class="built_in">String</span> candidateName : newCandidateNames) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">						BeanDefinition bd = registry.getBeanDefinition(candidateName);</span><br><span class="line">						<span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="built_in">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line">								!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">							candidates.add(<span class="keyword">new</span> BeanDefinitionHolder(bd, candidateName));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				candidateNames = newCandidateNames;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span></span><br><span class="line">		<span class="keyword">if</span> (sbr != <span class="literal">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">			sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.metadataReaderFactory <span class="keyword">instanceof</span> CachingMetadataReaderFactory) &#123;</span><br><span class="line">			<span class="comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span></span><br><span class="line">			<span class="comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span></span><br><span class="line">			((CachingMetadataReaderFactory) <span class="built_in">this</span>.metadataReaderFactory).clearCache();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="筛选出符合条件的BeanDefinition，打上标记"><a href="#筛选出符合条件的BeanDefinition，打上标记" class="headerlink" title="筛选出符合条件的BeanDefinition，打上标记"></a>筛选出符合条件的BeanDefinition，打上标记</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">	BeanDefinition beanDef = registry.get<span class="constructor">BeanDefinition(<span class="params">beanName</span>)</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">ConfigurationClassUtils</span>.</span></span>is<span class="constructor">FullConfigurationClass(<span class="params">beanDef</span>)</span> <span class="pattern-match"><span class="operator">||</span></span></span><br><span class="line"><span class="pattern-match">			<span class="constructor">ConfigurationClassUtils</span>.is<span class="constructor">LiteConfigurationClass(<span class="params">beanDef</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">		<span class="keyword">if</span> (logger.is<span class="constructor">DebugEnabled()</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">			logger.debug(&quot;<span class="constructor">Bean</span> definition has already been processed <span class="keyword">as</span> a configuration <span class="keyword">class</span>: &quot; + bean<span class="constructor">Def</span>);</span></span><br><span class="line"><span class="pattern-match">		&#125;</span></span><br><span class="line"><span class="pattern-match">	&#125;</span></span><br><span class="line"><span class="pattern-match">	<span class="operator">/</span><span class="operator">/</span> 如果有@<span class="constructor">Configuration</span>注解，标记为full；如果有@<span class="constructor">Component</span> @<span class="constructor">ComponentScan</span> @<span class="constructor">Import</span> @<span class="constructor">ImportResource</span>，则标记为lite</span></span><br><span class="line"><span class="pattern-match">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="constructor">ConfigurationClassUtils</span>.check<span class="constructor">ConfigurationClassCandidate(<span class="params">beanDef</span>, <span class="params">this</span>.<span class="params">metadataReaderFactory</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">		config<span class="constructor">Candidates</span>.add(<span class="keyword">new</span> <span class="constructor">BeanDefinitionHolder(<span class="params">beanDef</span>, <span class="params">beanName</span>)</span>);</span></span><br><span class="line"><span class="pattern-match">	&#125;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ConfigurationClassUtils.isFullConfigurationClass(beanDef)就是看BeanDefinition中有没有标签org.springframework.context.annotation.ConfigurationClassPostProcessor.configurationClass，并且值是不是full。<br>ConfigurationClassUtils.isLiteConfigurationClass(beanDef)就是看BeanDefinition中有没有标签org.springframework.context.annotation.ConfigurationClassPostProcessor.configurationClass，并且值是不是lite。<br>ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)，如果有@Configuration注解，标记为full；如果有@Component @ComponentScan @Import @ImportResource，则标记为lite，并加入备选集合。</p>
<h4 id="实例化一个ConfigurationClassParser，用来解析备选的BeanDefinition"><a href="#实例化一个ConfigurationClassParser，用来解析备选的BeanDefinition" class="headerlink" title="实例化一个ConfigurationClassParser，用来解析备选的BeanDefinition"></a>实例化一个ConfigurationClassParser，用来解析备选的BeanDefinition</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationClassParser parser = new ConfigurationClassParser(</span><br><span class="line">				<span class="keyword">this</span>.metadataReaderFactory, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.environment,</span><br><span class="line">				<span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.componentScanBeanNameGenerator, registry);</span><br></pre></td></tr></table></figure>
<p>实例化一个ConfigurationClassParser，里面实例化了一个bean扫描解析器ComponentScanAnnotationParser，一个condition计算器ConditionEvaluator。</p>
<h4 id="解析注解"><a href="#解析注解" class="headerlink" title="解析注解"></a>解析注解</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   SourceClass sourceClass = <span class="keyword">as</span><span class="constructor">SourceClass(<span class="params">configClass</span>)</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;			</span><br><span class="line">	<span class="comment">// 循环处理配置类configClass直到sourceClass变为null</span></span><br><span class="line">	<span class="comment">// doProcessConfigurationClass的返回值是其参数configClass的父类，</span></span><br><span class="line">	<span class="comment">// 如果该父类是由Java提供的类或者已经处理过，返回null</span></span><br><span class="line">	sourceClass = <span class="keyword">do</span><span class="constructor">ProcessConfigurationClass(<span class="params">configClass</span>, <span class="params">sourceClass</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (sourceClass != null);</span><br></pre></td></tr></table></figure>
<p>解析的核心逻辑在ConfigurationClassParser里面。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationClassParser.class</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">protected</span> final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)</span><br><span class="line">			throws IOException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Recursively process any member (nested) classes first</span></span><br><span class="line">		processMemberClasses(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line">		<span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">				sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">				org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">				processPropertySource(propertySource);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				logger.warn(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">						<span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line">		<span class="built_in">Set</span>&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">				sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">		<span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">				!<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">			<span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">				<span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line">				<span class="built_in">Set</span>&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">						<span class="built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">				<span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line">				<span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">					BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">					<span class="keyword">if</span> (bdCand == <span class="literal">null</span>) &#123;</span><br><span class="line">						bdCand = holder.getBeanDefinition();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">						parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any @Import annotations</span></span><br><span class="line">		processImports(configClass, sourceClass, getImports(sourceClass), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line">		AnnotationAttributes importResource =</span><br><span class="line">				AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">		<span class="keyword">if</span> (importResource != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">String</span>[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">			Class&lt;? <span class="keyword">extends</span> BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">String</span> resource : resources) &#123;</span><br><span class="line">				<span class="built_in">String</span> resolvedResource = <span class="built_in">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">				configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process individual @Bean methods</span></span><br><span class="line">		<span class="built_in">Set</span>&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">		<span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">			configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process default methods on interfaces</span></span><br><span class="line">		<span class="comment">// 处理接口上的缺省方法</span></span><br><span class="line">		processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process superclass, if any</span></span><br><span class="line">		<span class="comment">// 如果父类superclass存在，并且名称不是`java`开头的类，并且尚未处理，才返回它以便外层循环继续</span></span><br><span class="line">		<span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">			<span class="built_in">String</span> superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">			<span class="keyword">if</span> (superclass != <span class="literal">null</span> &amp;&amp; !superclass.startsWith(<span class="string">&quot;java&quot;</span>) &amp;&amp;</span><br><span class="line">					!<span class="built_in">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">				<span class="built_in">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">				<span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">				<span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>解析内部类</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process<span class="constructor">MemberClasses(<span class="params">configClass</span>, <span class="params">sourceClass</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>处理内部类和静态内部类，尽量避免这样使用。可以跳过</p>
</li>
<li><p>处理配置类上的注解@PropertySources,@PropertySource</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line"><span class="keyword">for</span> (AnnotationAttributes <span class="attr">propertySource :</span> AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">		sourceClass.getMetadata(), PropertySources.<span class="keyword">class</span>,</span><br><span class="line">		org.springframework.context.annotation.PropertySource.<span class="keyword">class</span>)) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">		processPropertySource(propertySource);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		logger.warn(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">				<span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载配置文件的，逻辑比较简单，可以跳过。</p>
</li>
<li><p>处理配置类上的注解@ComponentScans,@ComponentScan</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">      // Process <span class="keyword">any</span> @ComponentScan annotations</span><br><span class="line"><span class="keyword">Set</span>&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">		sourceClass.getMetadata(), ComponentScans.<span class="keyword">class</span>, ComponentScan.<span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">		!this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">	<span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">		// The config <span class="keyword">class</span> <span class="keyword">is</span> annotated <span class="keyword">with</span> @ComponentScan -&gt; <span class="keyword">perform</span> the scan immediately</span><br><span class="line">		<span class="keyword">Set</span>&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">				this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">		// <span class="keyword">Check</span> the <span class="keyword">set</span> <span class="keyword">of</span> scanned definitions <span class="keyword">for</span> <span class="keyword">any</span> further config classes <span class="keyword">and</span> parse recursively <span class="keyword">if</span> needed</span><br><span class="line">		<span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">			BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">			<span class="keyword">if</span> (bdCand == <span class="keyword">null</span>) &#123;</span><br><span class="line">				bdCand = holder.getBeanDefinition();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;</span><br><span class="line">				parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段的核心其实我们讲过，<code>Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =this.componentScanParser.parse(componentScan,sourceClass.getMetadata().getClassName())</code>;在讲@Component注解的时候，我们是通过对component-scan标签的解析来说明的，这里就是其中的核心解析部分。在这一步走完的时候，我们能看到我们的BeanFactory里面多了configBean3和configBean4的BeanDefinition。至于下面的循环，就是对conponent-scan的class里面有@Configuration注解的Bean再次进行解析，和套娃一样。</p>
</li>
<li><p>处理配置类上的注解@Import ####<br>如果Import的类实现了ImportSelector，并且还实现了其子接口DeferredImportSelector，会将其转化为DeferredImportSelectorHolder加入到ConfigurationClass的deferredImportSelectors；<br>如果实现了ImportSelector，但没有实现其子接口DeferredImportSelector，会执行其selectImports方法，并对其返回结果再次执行processImports。<br>如果Import的类实现了ImportBeanDefinitionRegistrar，会根据其类型和实现Aware接口，执行其Aware接口的set方法，并将其加入到ConfigurationClass的importBeanDefinitionRegistrars。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process<span class="constructor">Imports(<span class="params">configClass</span>, <span class="params">sourceClass</span>, <span class="params">getImports</span>(<span class="params">sourceClass</span>)</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>处理配置类上的注解@ImportResource ####<br>加入ConfigurationClass的importedResources。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line">AnnotationAttributes importResource =</span><br><span class="line">		<span class="module-access"><span class="module"><span class="identifier">AnnotationConfigUtils</span>.</span></span>attributes<span class="constructor">For(<span class="params">sourceClass</span>.<span class="params">getMetadata</span>()</span>, <span class="module-access"><span class="module"><span class="identifier">ImportResource</span>.</span></span><span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">if</span> (importResource != null) &#123;</span><br><span class="line">	String<span class="literal">[]</span> resources = importResource.get<span class="constructor">StringArray(<span class="string">&quot;locations&quot;</span>)</span>;</span><br><span class="line">	Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.get<span class="constructor">Class(<span class="string">&quot;reader&quot;</span>)</span>;</span><br><span class="line">	<span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line">		String resolvedResource = this.environment.resolve<span class="constructor">RequiredPlaceholders(<span class="params">resource</span>)</span>;</span><br><span class="line">		configClass.add<span class="constructor">ImportedResource(<span class="params">resolvedResource</span>, <span class="params">readerClass</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>处理配置类上的注解@Bean ####<br>构造BeanMethod，加入ConfigurationClass的beanMethods。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      Set&lt;MethodMetadata&gt; beanMethods = retrieve<span class="constructor">BeanMethodMetadata(<span class="params">sourceClass</span>)</span>;</span><br><span class="line"><span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">	configClass.add<span class="constructor">BeanMethod(<span class="params">new</span> BeanMethod(<span class="params">methodMetadata</span>, <span class="params">configClass</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="加载BeanDefinition"><a href="#加载BeanDefinition" class="headerlink" title="加载BeanDefinition"></a>加载BeanDefinition</h4><p>@ComponentScan扫描出来的BeanDefinition在扫描的过程中就已经被注册到容器中了，但是@ImportResource @Import @Bean扫描出来的只是被加入到了ConfigurationClass里面，还没有被注册到容器中，所以下一步就是将ConfigurationClass转化成为BeanDefinition。走到this.reader.loadBeanDefinitions(configClasses)：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="selector-tag">private</span> <span class="selector-tag">void</span> <span class="selector-tag">loadBeanDefinitionsForConfigurationClass</span>(</span><br><span class="line">		ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) &#123;</span><br><span class="line"></span><br><span class="line">	……</span><br><span class="line">	<span class="comment">// 如果自身是被@Import注释修饰，注册自己</span></span><br><span class="line">	<span class="selector-tag">if</span> (configClass.isImported()) &#123;</span><br><span class="line">		<span class="selector-tag">registerBeanDefinitionForImportedConfigurationClass</span>(configClass);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="selector-tag">for</span> (BeanMethod <span class="attribute">beanMethod </span>: configClass.getBeanMethods()) &#123;</span><br><span class="line">		<span class="selector-tag">loadBeanDefinitionsForBeanMethod</span>(beanMethod);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="selector-tag">loadBeanDefinitionsFromImportedResources</span>(configClass.getImportedResources());</span><br><span class="line">	<span class="selector-tag">loadBeanDefinitionsFromRegistrars</span>(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于@Bean注解，会把BeanMethod的ConfigurationClass属性转化为ConfigurationClassBeanDefinition，并设置factoryBeanName和factoryMethodName。当我们实例化的时候，返回factoryMethodName返回的结果。<br>如果定义了ImportedResources，loadBeanDefinitionsFromImportedResources会将配置文件解析为BeanDefinitions，并注册到容器中。<br>如果Import引入的类实现了ImportBeanDefinitionRegistrar，会在loadBeanDefinitionsFromRegistrars注册。<br>至此，全部配置被转化为BeanDefinitions，并注册到容器。</p>
<h3 id="postProcessBeanFactory-ConfigurableListableBeanFactory-beanFactory"><a href="#postProcessBeanFactory-ConfigurableListableBeanFactory-beanFactory" class="headerlink" title="postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)"></a>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   @Override</span><br><span class="line">public void post<span class="constructor">ProcessBeanFactory(ConfigurableListableBeanFactory <span class="params">beanFactory</span>)</span> &#123;</span><br><span class="line">	……</span><br><span class="line">	enhance<span class="constructor">ConfigurationClasses(<span class="params">beanFactory</span>)</span>;</span><br><span class="line">	beanFactory.add<span class="constructor">BeanPostProcessor(<span class="params">new</span> ImportAwareBeanPostProcessor(<span class="params">beanFactory</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对配置类进行增强"><a href="#对配置类进行增强" class="headerlink" title="对配置类进行增强"></a>对配置类进行增强</h4><p>enhanceConfigurationClasses(beanFactory)对所有@Configuration注解的类做了增强，主要是添加了两个回调拦截器。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> final Callback[] CALLBACKS = <span class="keyword">new</span> <span class="type">Callback</span>[] &#123;</span><br><span class="line">		<span class="keyword">new</span> <span class="type">BeanMethodInterceptor</span>(),</span><br><span class="line">		<span class="keyword">new</span> <span class="type">BeanFactoryAwareMethodInterceptor</span>(),</span><br><span class="line">		NoOp.INSTANCE</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>BeanMethodInterceptor是拦截@Bean的方法，BeanFactoryAwareMethodInterceptor拦截BeanFactoryAware的setBeanFactory()方法。<br>至于这些增强在什么时候生效，等我们看完AOP，再来仔细梳理。</p>
</div><div class="tags"><a href="/tags/spring/"><i class="fa fa-tag"></i>spring</a><a href="/tags/%E6%BA%90%E7%A0%81/"><i class="fa fa-tag"></i>源码</a><a href="/tags/%E6%9E%B6%E6%9E%84/"><i class="fa fa-tag"></i>架构</a></div><div class="post-nav"><a class="pre" href="/2021/01/07/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%85%AB)-----%E7%90%86%E8%A7%A3AOP/">spring源码阅读(八)-----理解AOP</a><a class="next" href="/2020/12/20/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%85%AD)-----ClassPathXmlApplicationContext%E6%B5%81%E7%A8%8B/">spring源码阅读(六)-----ClassPathXmlApplicationContext流程</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'m1L4QofvaTBynd4G4ARXUBIv-gzGzoHsz',
  appKey:'q7tSFtGgIvgO1ScyMtQdvUkR',
  placeholder:'Just so so',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/spring%E6%BA%90%E7%A0%81/">spring源码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 15px;">源码</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 15px;">架构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/03/11/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%8D%81)-----SpringBoot%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E7%BD%AETomcat/">spring源码阅读(一)-----核心流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/07/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%85%AB)-----%E7%90%86%E8%A7%A3AOP/">spring源码阅读(八)-----理解AOP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%83)-----%E7%90%86%E8%A7%A3@Configuration/">spring源码阅读(七)-----理解@Configuration</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%85%AD)-----ClassPathXmlApplicationContext%E6%B5%81%E7%A8%8B/">spring源码阅读(六)-----ClassPathXmlApplicationContext流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/18/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%94)-----%E7%90%86%E8%A7%A3@Component/">spring源码阅读(五)-----理解@Component</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/16/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E5%9B%9B)-----%E7%90%86%E8%A7%A3@Autowired/">spring源码阅读(四)-----理解@Autowired</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/14/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%89)-----Bean%E7%9A%84%E5%8A%A0%E8%BD%BD/">spring源码阅读(三)-----Bean的加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/01/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%BA%8C)-----BeanDefinition%E7%9A%84%E6%B3%A8%E5%86%8C/">spring源码阅读(二)-----资源加载与BeanDefinition注册</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/01/spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB(%E4%B8%80)-----%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/">spring源码阅读(一)-----核心流程</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">不喝酒的烟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":350,"height":650},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>